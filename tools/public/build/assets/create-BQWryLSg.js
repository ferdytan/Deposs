import{r as d,K as ee,j as e,L as ae,$ as te,S as se}from"./app-DS_U6FTt.js";import{A as re}from"./app-layout-B3xwN8mX.js";import{I as ie}from"./layout-BnmWjq6O.js";import{D as A}from"./dropdown.esm-D1achfQ9.js";import{H as ne}from"./heading-BktP5NcV.js";import{B as F}from"./app-logo-icon-DGp3hhn2.js";import{I as x}from"./input-BoUIE62w.js";import{L as u}from"./label-BVuRm3E6.js";/* empty css            */import"./index-BGtW6CPw.js";import"./Combination-ByE_FHkl.js";import"./index-Cf151ExV.js";import"./index-BuN6fwHd.js";function fe(){const[k,I]=d.useState(new Set),[w,$]=d.useState({}),[y,B]=d.useState({}),O=(a,s)=>`${a}:${s}`,q=(a,s)=>y[O(a,s)]??1,G=(a,s,t)=>{const l=Number.isFinite(t)&&t>0?Math.floor(t):1;B(o=>({...o,[O(a,s)]:l}))},[D,Q]=d.useState(null),U=ee(),{customers:_,invoice_number:K}=U.props,S=new Date,M=new Date(S);M.setDate(S.getDate()+7);const[r,j]=d.useState({customer_id:"",invoice_number:K||"",period_start:S.toISOString().split("T")[0],period_end:M.toISOString().split("T")[0],subtotal:0,ppn:0,grand_total:0,terbilang:"",applyMaterai:!0,materai:1e4}),[p,J]=d.useState(""),[c,T]=d.useState([]),[h,f]=d.useState(new Set),[m,E]=d.useState("");d.useEffect(()=>{console.log("DATA ORDERS",c)},[c]),d.useEffect(()=>{if(p){const a=_.find(s=>s.id.toString()===p);a&&T(a.orders||[])}else T([])},[p,_]),d.useEffect(()=>{c.length>0&&console.log("[DEBUG] Orders Loaded:",c)},[c]),d.useEffect(()=>{if(!p){I(new Set);return}const a=`/orders/unavailable?customer_id=${p}&period_start=${r.period_start}&period_end=${r.period_end}`;fetch(a).then(s=>s.json()).then(s=>{I(new Set(s)),f(t=>new Set([...t].filter(o=>!s.includes(o))))}).catch(console.error)},[p,r.period_start,r.period_end]);const z=a=>"Sepuluh Juta Tujuh Ratus Sembilan Puluh Sembilan Ribu Dua Ratus Rupiah";d.useEffect(()=>{if(c.length>0&&h.size>0&&m){const{subtotal:a,ppn:s,grandTotal:t,terbilang:l}=H(c,m,h,r.materai,z,y);j(o=>({...o,subtotal:a,ppn:s,grand_total:t,terbilang:l}))}else j(a=>({...a,subtotal:0,ppn:0,grand_total:0,terbilang:""}))},[h,c,r.materai,m,y]);function H(a,s,t,l,o,i){let n=0;const g=a.find(b=>b.id.toString()===s);g&&g.order_items.forEach(b=>{var R;t.has(b.id)&&(n+=Number(b.price_value||0),(R=b.additional_products)==null||R.forEach(L=>{var P;const Z=i[`${b.id}:${L.id}`]??1;n+=Number(((P=L.pivot)==null?void 0:P.price_value)||0)*Z}))});const N=Math.round(n*.11),v=n+N+l,C=o(v);return{subtotal:n,ppn:N,grandTotal:v,terbilang:C}}const W=a=>{J(a),E(""),f(new Set)},V=a=>{E(a),f(new Set);const s=c.find(t=>t.id.toString()===a);console.log("[DEBUG] Selected Order:",s)},X=(a,s)=>{const t=new Set(h);s?t.add(a):t.delete(a),f(t)},Y=async a=>{var l,o;if(a.preventDefault(),!r.terbilang){$({terbilang:["Terbilang harus diisi"]}),alert("Terbilang harus diisi");return}const s=c.find(i=>i.id.toString()===m),t=(s==null?void 0:s.order_items.filter(i=>h.has(i.id)).flatMap(i=>(i.additional_products??[]).map(n=>({order_item_id:i.id,additional_product_id:n.id,quantity:y[`${i.id}:${n.id}`]??1}))))??[];try{await se.post("/invoices/preview",{...r,customer_id:p,order_id:m,order_ids:[m],order_item_ids:Array.from(h),additional_product_quantities:t,applyMaterai:r.applyMaterai})}catch(i){const n=i;((l=n.response)==null?void 0:l.status)===422?($(((o=n.response.data)==null?void 0:o.errors)??{}),Q("Terjadi kesalahan saat menyimpan invoice. Silakan coba lagi nanti.")):alert("Terjadi kesalahan saat menyimpan invoice.")}};return e.jsxs(re,{breadcrumbs:de,children:[e.jsx(ae,{title:"Create Invoice"}),e.jsx(ie,{children:e.jsxs("div",{className:"mx-auto max-w-4xl space-y-6",children:[e.jsx(ne,{title:"Create Invoice",description:"Pilih customer dan kontainer untuk membuat invoice."}),D&&e.jsxs("div",{className:"relative mb-4 rounded border border-red-400 bg-red-100 px-4 py-3 text-red-700",children:[e.jsx("strong",{className:"font-bold",children:"Error:"}),e.jsx("span",{className:"mt-1 block text-sm",children:D})]}),Object.keys(w).length>0&&e.jsxs("div",{className:"relative mb-4 rounded border border-red-400 bg-red-100 px-4 py-3 text-red-700",children:[e.jsx("strong",{className:"font-bold",children:"Terjadi Kesalahan:"}),e.jsx("ul",{className:"mt-2 list-disc pl-5",children:Object.entries(w).map(([a,s])=>s.map((t,l)=>e.jsx("li",{className:"text-sm",children:t},`${a}-${l}`)))})]}),e.jsxs("form",{onSubmit:Y,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"invoice_number",children:"Nomor Invoice"}),e.jsx(x,{name:"invoice_number",value:r.invoice_number,readOnly:!0,className:"bg-gray-100"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"customer",children:"Customer"}),e.jsx(A,{value:p,options:_.map(a=>({label:a.name,value:a.id.toString()})),onChange:a=>W(a.value),placeholder:"Pilih atau cari customer...",filter:!0,filterPlaceholder:"Cari customer...",showClear:!0,className:"w-full",emptyMessage:"Tidak ada customer ditemukan."})]}),p&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"order",children:"Nomor Order/AJU"}),e.jsx(A,{value:m,options:c.map(a=>({label:`Order #${a.order_id} (${a.container_number})`,value:a.id.toString()})),onChange:a=>V(a.value),placeholder:"Pilih atau cari nomor order/AJU...",filter:!0,filterPlaceholder:"Cari order...",showClear:!0,className:"w-full",emptyMessage:"Tidak ada order tersedia.",disabled:!p})]}),m&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Nomor Kontainer"}),e.jsx("div",{className:"space-y-3 rounded-md border p-4",children:c.filter(a=>a.id.toString()===m).flatMap(a=>{var s;return((s=a.order_items)==null?void 0:s.map(t=>{var o;console.log("[DEBUG] Additional Products:",t.additional_products);const l=Number(t.price_value||0);return e.jsxs("div",{className:"mb-2 space-y-2 border-b pb-2",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"checkbox",disabled:k.has(t.id),onChange:i=>X(t.id,i.target.checked),checked:h.has(t.id)}),e.jsxs("label",{htmlFor:`orderitem-${t.id}`,className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:t.container_number}),k.has(t.id)&&e.jsx("span",{className:"ml-1 inline-block rounded bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800",children:"Sudah pernah dibuat"}),e.jsx("div",{className:"text-sm text-gray-500",children:((o=t.product)==null?void 0:o.service_type)??"-"})]}),e.jsxs("div",{className:"w-32 text-right",children:["Rp ",l.toLocaleString("id-ID")]})]}),t.additional_products&&t.additional_products.length>0&&e.jsxs("div",{className:"ml-6 gap-5 space-y-1 pt-3 text-xs text-gray-500 italic",children:[e.jsx("span",{className:"mt-3",children:"Additional Product:"}),t.additional_products.map(i=>{var v;const n=Number(((v=i.pivot)==null?void 0:v.price_value)||0),g=q(t.id,i.id),N=n*g;return e.jsxs("div",{className:"mt-2 flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{children:["• ",i.service_type||`Produk Tambahan #${i.id}`]}),e.jsxs("div",{className:"flex items-center gap-1 not-italic",children:[e.jsx("label",{className:"text-[11px] text-gray-600",children:"Qty"}),e.jsx("input",{type:"number",min:1,step:1,value:g,onChange:C=>G(t.id,i.id,Number(C.target.value)),className:"h-7 w-16 rounded border px-2 text-xs",disabled:!h.has(t.id)})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{children:["Rp ",n.toLocaleString("id-ID")]}),e.jsxs("div",{className:"text-[11px] text-gray-600",children:["× ",g," ="," ",e.jsxs("span",{className:"font-medium",children:["Rp ",N.toLocaleString("id-ID")]})]})]})]},i.id)})]})]},t.id)}))??[]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"period_start",children:"Periode Mulai"}),e.jsx(x,{id:"period_start",name:"period_start",type:"date",value:r.period_start,onChange:a=>j({...r,period_start:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"period_end",children:"Periode Akhir"}),e.jsx(x,{id:"period_end",name:"period_end",type:"date",value:r.period_end,onChange:a=>j({...r,period_end:a.target.value})})]})]}),e.jsx(x,{name:"terbilang",value:r.terbilang,type:"hidden"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Subtotal"}),e.jsx(x,{name:"subtotal",value:isNaN(r.subtotal)?"0":`Rp ${r.subtotal.toLocaleString("id-ID")}`,readOnly:!0,className:"bg-gray-100"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"PPN (11%)"}),e.jsx(x,{name:"ppn",value:`Rp ${r.ppn.toLocaleString("id-ID")}`,readOnly:!0,className:"bg-gray-100"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Materai"}),e.jsx(x,{name:"materai",value:`Rp ${r.materai.toLocaleString("id-ID")}`,readOnly:!0,disabled:!r.applyMaterai,className:`bg-gray-100 ${r.applyMaterai?"":"opacity-50"}`})]}),e.jsxs("div",{className:"mt-4 flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"applyMaterai",checked:r.applyMaterai,onChange:a=>{const s=a.target.checked;j(t=>({...t,applyMaterai:s,materai:s?1e4:0}))}}),e.jsx("label",{htmlFor:"applyMaterai",className:"text-sm font-medium",children:"Terapkan Materai (Rp 10.000)"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Grand Total"}),e.jsx(x,{name:"grand_total",value:`Rp ${r.grand_total.toLocaleString()}`,readOnly:!0,className:"bg-gray-100"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(F,{variant:"outline",asChild:!0,children:e.jsx(te,{href:"/invoices",children:"Batal"})}),e.jsx(F,{type:"submit",disabled:!p||!m||h.size===0,children:"Simpan Invoice"})]})]})]})})]})}const de=[{title:"Master Invoice",href:"/invoices"},{title:"Create Invoice",href:"/invoices/create"}];export{fe as default};
