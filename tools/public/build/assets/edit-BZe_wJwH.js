import{m as ie,r as x,a as le,j as e,L as de}from"./app-DS_U6FTt.js";import{B as _}from"./app-logo-icon-DGp3hhn2.js";import{D as oe,a as ne,b as ce,c as me,d as ue}from"./dialog-CrSJXzBc.js";import{I as m}from"./input-BoUIE62w.js";import{L as o}from"./label-BVuRm3E6.js";import{S as pe,a as he,b as xe,c as _e,d as ge,e as je}from"./select-HCChz6OX.js";import{A as ve,X as fe}from"./app-layout-B3xwN8mX.js";import{O as ye}from"./layout-DEUbyeni.js";import{D as w}from"./dropdown.esm-D1achfQ9.js";import{T as Ne}from"./trash-2-C6nS2EgX.js";import{C as U}from"./circle-plus-Bs5dk7J_.js";/* empty css            */import"./index-BGtW6CPw.js";import"./index-Cf151ExV.js";import"./Combination-ByE_FHkl.js";import"./index-BvLh-YW8.js";import"./index-BuN6fwHd.js";function Ke({order:h,customers:H,shippers:K}){const M=h.items.map(a=>{const s={};return a.rekam_suhu.forEach(t=>{s[t.tanggal]=t.jam_data}),{id:a.id,product_id:a.product_id.toString(),additional_product_ids:a.additional_products.map(t=>t.id.toString()),container_number:a.container_number,entry_date:a.entry_date??"",eir_date:a.eir_date??"",exit_date:a.exit_date??"",commodity:a.commodity??"",country:a.country??"",vessel:a.vessel??"",price_type:a.price_type??void 0,price_value:a.price_value??void 0,temperature:Object.keys(s).length?s:void 0}}),O=(a,s,t)=>a.map(i=>{const d=t.find(r=>r.id.toString()===i);let c="0";return d&&(s==="20ft"?c=d.custom_price_20ft??"0":s==="40ft"?c=d.custom_price_40ft??"0":c=d.custom_global_price??"0"),`${i}:${c}`}),{data:l,setData:n,put:F,processing:j,errors:p}=ie({customer_id:h.customer_id.toString(),shipper_id:h.shipper_id?h.shipper_id.toString():"",no_aju:h.no_aju??"",fumigasi:h.fumigasi??null,order_items:M}),[y,T]=x.useState(!h.no_aju),[P]=x.useState(h.order_id),V=()=>{T(!0),n("no_aju","")},J=()=>{T(!1)},B=()=>{n("order_items",[...l.order_items,{id:void 0,product_id:"",additional_product_ids:[],container_number:"",entry_date:"",eir_date:"",exit_date:"",commodity:"",country:"",vessel:"",price_type:void 0,price_value:void 0,temperature:void 0}])},q=a=>{n("order_items",l.order_items.filter((s,t)=>t!==a))},u=(a,s,t)=>{const i=[...l.order_items];if(i[a][s]=t,s==="price_type"){const d=I(i[a].product_id);let c;d&&(t==="20ft"?c=d.custom_price_20ft:t==="40ft"?c=d.custom_price_40ft:c=d.custom_global_price),i[a].price_value=c;const r=i[a].additional_product_ids||[];i[a].additional_product_prices=O(r,t,f)}n("order_items",i)},z=a=>{const s=l.order_items[a].container_number.trim().toUpperCase();return l.order_items.some((t,i)=>i!==a&&t.container_number.trim().toUpperCase()===s&&s.length>0)},G=a=>{if(a.preventDefault(),n("error",void 0),l.fumigasi&&l.fumigasi.trim()!==""&&!l.shipper_id){n("error","Shipper wajib diisi karena catatan Fumigator diisi.");return}F(route("orders.update",h.id))},[X,N]=x.useState(!1),[b,D]=x.useState(null),[S,g]=x.useState([]),Q=a=>{var t;D(a);const s=(t=l.order_items[a])==null?void 0:t.temperature;if(s&&Object.keys(s).length>0){const i=Object.entries(s).map(([d,c])=>({date:d,temps:c}));g(i)}else g([{date:new Date().toISOString().slice(0,10),temps:{}}]);N(!0)},W=(a,s)=>{g(t=>{const i=[...t];return i[a].date=s,i})},Y=(a,s,t)=>{g(i=>{const d=[...i];return d[a].temps={...d[a].temps,[s.toString().padStart(2,"0")]:t},d})},Z=()=>{g(a=>[...a,{date:"",temps:{}}])},ee=a=>{g(s=>s.filter((t,i)=>i!==a))},ae=()=>{if(b===null)return;const a={};S.forEach(t=>{t.date&&(a[t.date]=t.temps)});const s=[...l.order_items];s[b]={...s[b],temperature:a},n("order_items",s),N(!1),D(null),g([])},[f,L]=x.useState([]),[C,R]=x.useState(!1),E=x.useRef(!0);x.useEffect(()=>{l.customer_id?(R(!0),le.get(`/api/customers/${l.customer_id}/products`).then(a=>{L(a.data),E.current||n("order_items",l.order_items.map(s=>({...s,product_id:"",additional_product_ids:[],price_type:void 0,price_value:void 0}))),E.current=!1}).finally(()=>R(!1))):(L([]),n("order_items",l.order_items.map(a=>({...a,product_id:"",additional_product_ids:[],price_type:void 0,price_value:void 0}))))},[l.customer_id]);const I=a=>f.find(s=>s.id===Number(a));return e.jsxs(ve,{children:[e.jsx(de,{title:"Edit Order"}),e.jsx(ye,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Edit Order"}),p.error&&e.jsx("div",{className:"mb-2 rounded bg-red-100 px-4 py-2 text-sm text-red-700",children:p.error}),e.jsxs("form",{onSubmit:G,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(o,{children:"Jenis Nomor Order"}),e.jsxs("div",{className:"mt-5 flex flex-row gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{type:"radio",checked:y,onChange:V}),e.jsx(o,{children:"Nomor Order Otomatis"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{type:"radio",checked:!y,onChange:J}),e.jsx(o,{children:"Nomor AJU"})]})]})]}),y?e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:"Nomor Order"}),e.jsx(m,{value:P,readOnly:!0,className:"cursor-not-allowed bg-gray-100"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:"Nomor AJU"}),e.jsx(m,{value:l.no_aju,onChange:a=>n("no_aju",a.target.value),placeholder:"Masukkan Nomor AJU",required:!0}),p.no_aju&&e.jsx("p",{className:"text-sm text-red-500",children:p.no_aju})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:"Pilih Customer"}),e.jsx(w,{value:l.customer_id,options:H.map(a=>({label:a.name,value:a.id.toString()})),optionLabel:"label",optionValue:"value",placeholder:"Pilih atau cari Customer",filter:!0,filterPlaceholder:"Cari customer...",showClear:!0,onChange:a=>n("customer_id",a.value),className:"w-full",disabled:j}),p.customer_id&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:p.customer_id})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:"Pilih Shipper"}),e.jsx(w,{value:l.shipper_id,options:K.map(a=>({label:a.name,value:a.id.toString()})),optionLabel:"label",optionValue:"value",placeholder:"Pilih atau cari Shipper",filter:!0,filterPlaceholder:"Cari shipper...",showClear:!0,onChange:a=>n("shipper_id",a.value),className:"w-full",disabled:j}),p.shipper_id&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:p.shipper_id})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:"Fumigator"}),e.jsx("textarea",{value:l.fumigasi??"",onChange:a=>n("fumigasi",a.target.value),placeholder:"Masukkan catatan Fumigator (opsional)...",className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none",rows:3,disabled:j}),p.fumigasi&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:p.fumigasi})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(o,{children:"Layanan & Nomor Kontainer"}),l.order_items.map((a,s)=>{const t=I(a.product_id),i=(t==null?void 0:t.requires_temperature)||!1,d=[{label:"Harga 20ft",value:"20ft",price:t==null?void 0:t.custom_price_20ft},{label:"Harga 40ft",value:"40ft",price:t==null?void 0:t.custom_price_40ft},{label:"Harga Global",value:"global",price:t==null?void 0:t.custom_global_price}].filter(r=>r.price!==void 0&&r.price!==null),c=Object.keys(a.temperature??{}).length>0;return e.jsxs("div",{children:[e.jsxs("div",{className:"space-y-4 rounded-lg border p-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"min-w-[200px] flex-1",children:[e.jsx(o,{children:"Produk"}),e.jsx(w,{value:a.product_id,options:f.map(r=>({label:r.service_type,value:r.id.toString()})),optionLabel:"label",optionValue:"value",placeholder:C?"Memuat...":"Pilih Layanan",filter:!0,filterPlaceholder:"Cari layanan...",showClear:!0,onChange:r=>{u(s,"product_id",r.value),u(s,"price_type",void 0)},disabled:!l.customer_id||C,className:"w-full"})]}),e.jsxs("div",{className:"min-w-[160px] flex-1",children:[e.jsx(o,{children:"Pilih Harga"}),e.jsxs(pe,{value:a.price_type,disabled:!a.product_id||d.length===0,onValueChange:r=>u(s,"price_type",r),children:[e.jsx(he,{children:e.jsx(xe,{placeholder:"Pilih Harga"})}),e.jsx(_e,{children:d.map(r=>e.jsxs(ge,{value:r.value,children:[r.label," ",r.price?`: Rp${Number(r.price).toLocaleString()}`:""]},r.value))})]}),a.price_type&&a.price_value&&e.jsxs("div",{className:"mt-1 text-sm text-gray-700",children:["Harga dipilih: Rp",Number(a.price_value).toLocaleString()]}),d.length===0&&e.jsx("div",{className:"mt-1 text-sm text-red-500",children:"Tidak ada harga untuk produk ini"})]}),e.jsxs("div",{className:"min-w-[200px] flex-1",children:[e.jsx(o,{children:"Additional Produk"}),e.jsx("div",{className:"max-h-32 overflow-y-auto rounded border px-2 py-1",children:f.map(r=>{var $;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:(($=a.additional_product_ids)==null?void 0:$.includes(r.id.toString()))||!1,onChange:se=>{var A;const te=se.target.checked,k=r.id.toString();let v=((A=a.additional_product_ids)==null?void 0:A.slice())||[];te?v.includes(k)||v.push(k):v=v.filter(re=>re!==k),u(s,"additional_product_ids",v),u(s,"additional_product_prices",O(v,l.order_items[s].price_type,f))},disabled:C||!l.customer_id||r.id.toString()===a.product_id}),e.jsx("label",{children:r.service_type})]},r.id)})})]}),e.jsxs("div",{className:"min-w-[200px] flex-1",children:[e.jsx(o,{children:"Nomor Kontainer"}),e.jsx(m,{value:a.container_number,onChange:r=>u(s,"container_number",r.target.value.toUpperCase()),placeholder:"EMCU1234567",maxLength:11}),z(s)&&e.jsx("p",{className:"text-sm text-red-500",children:"Nomor kontainer sudah dipakai"})]}),i&&e.jsx("div",{className:"flex items-end",children:e.jsxs("div",{children:[e.jsx(_,{type:"button",variant:"outline",onClick:()=>Q(s),children:"Rekam Suhu"}),c?e.jsx("p",{className:"mt-1 text-xs text-green-600",children:"Data suhu telah tercatat."}):e.jsx("p",{className:"mt-1 text-xs text-gray-600",children:"Produk ini memerlukan rekaman suhu."})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Country"}),e.jsx(m,{value:a.country,onChange:r=>u(s,"country",r.target.value),placeholder:"Negara tujuan"})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Nama Kapal (Vessel)"}),e.jsx(m,{value:a.vessel||"",onChange:r=>u(s,"vessel",r.target.value),placeholder:"Nama Kapal"})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Tanggal Masuk"}),e.jsx(m,{type:"datetime-local",value:a.entry_date,onChange:r=>u(s,"entry_date",r.target.value)})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Tanggal EIR"}),e.jsx(m,{type:"datetime-local",value:a.eir_date,onChange:r=>u(s,"eir_date",r.target.value)})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Tanggal Keluar"}),e.jsx(m,{type:"datetime-local",value:a.exit_date,onChange:r=>u(s,"exit_date",r.target.value)})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Komoditi"}),e.jsx(m,{value:a.commodity,onChange:r=>u(s,"commodity",r.target.value),placeholder:"Contoh: Barang Elektronik"})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(_,{type:"button",variant:"destructive",size:"icon",onClick:()=>q(s),children:e.jsx(Ne,{className:"h-4 w-4"})})})]},s),e.jsx(je,{className:"mt-5"})]})}),e.jsxs(_,{type:"button",variant:"outline",size:"sm",onClick:B,children:[e.jsx(U,{className:"mr-1 h-4 w-4"})," Tambah Layanan"]})]}),y&&e.jsx("input",{type:"hidden",name:"order_id",value:P}),e.jsx("input",{type:"hidden",name:"order_items",value:JSON.stringify(l.order_items)}),e.jsx(oe,{open:X,onOpenChange:N,children:e.jsxs(ne,{className:"max-w-3xl",children:[e.jsx(ce,{children:e.jsx(me,{children:"Rekam Suhu Kontainer"})}),e.jsxs("div",{className:"max-h-[60vh] space-y-6 overflow-y-auto pr-2",children:[S.map((a,s)=>e.jsxs("div",{className:"space-y-2 rounded border p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{htmlFor:`date_${s}`,children:"Tanggal"}),e.jsx(m,{id:`date_${s}`,type:"date",value:a.date,onChange:t=>W(s,t.target.value),className:"max-w-[180px]"}),S.length>1&&e.jsx(_,{type:"button",size:"icon",variant:"destructive",className:"ml-auto",onClick:()=>ee(s),children:e.jsx(fe,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid max-h-64 grid-cols-2 gap-2 overflow-y-auto",children:[...Array(24)].map((t,i)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(o,{htmlFor:`temp_${s}_${i}`,children:[i.toString().padStart(2,"0"),":00"]}),e.jsx(m,{id:`temp_${s}_${i}`,type:"number",step:"0.1",value:a.temps[i.toString().padStart(2,"0")]||"",onChange:d=>Y(s,i,d.target.value),className:"w-24"})]},i))})]},s)),e.jsxs(_,{type:"button",variant:"outline",onClick:Z,className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4"})," Tambah Tanggal"]})]}),e.jsxs(ue,{className:"gap-2",children:[e.jsx(_,{variant:"outline",onClick:()=>N(!1),children:"Batal"}),e.jsx(_,{onClick:ae,children:"Simpan"})]})]})}),e.jsx("div",{className:"flex flex-col-reverse gap-4 sm:flex-row sm:items-center sm:justify-between",children:e.jsxs(_,{type:"submit",disabled:j,className:"w-full sm:w-auto",children:[j&&e.jsx("span",{className:"mr-2 animate-spin",children:"●"}),j?"Memproses...":"Simpan Perubahan"]})})]})]})})]})}export{Ke as default};
